const token = document.querySelector('meta[name="token"]').content;

const leds_checkbox = document.getElementById('leds-switch');
const leds = document.getElementById('leds');
leds_checkbox.addEventListener('change', () => {
    fetch('/toggle/leds', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Token': token,
        }
    })
    .then(res => res.json())
    .then(data => {
        leds.className = 'leds ' + (data.leds_on ? 'on' : 'off');
        leds_checkbox.checked = data.leds_on;
    })
    .catch(err => console.error('Error toggling LEDs: ', err));
});

const fan_checkbox = document.getElementById('fan-switch');
const fan = document.getElementById('fan');
fan_checkbox.addEventListener('change', () => {
    fetch('/toggle/fan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Token': token,
        }
    })
    .then(res => res.json())
    .then(data => {
        fan.className = 'fan ' + (data.fan_on ? 'on' : 'off');
        fan_checkbox.checked = data.fan_on;
    })
    .catch(err => console.error('Error toggling fan: ', err));
});

const fanRpmElem = document.getElementById('cpu-temperature');  // assumes <span id="fan-rpm"></span> in HTML

function updateFanRpm() {
    fetch('/metrics/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Token': token,
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.temperature !== null && data.temperature !== undefined) {
            fanRpmElem.textContent = data.temperature.toFixed(2) + ' C';
        } else {
            fanRpmElem.textContent = 'â€”';
        }
    })
    .catch(err => {
        console.error('Error reading CPU temp:', err);
        fanRpmElem.textContent = 'Error';
    });
}

// poll every second
setInterval(updateFanRpm, 1000);
updateFanRpm();

const serviceStatuses = document.getElementById('service-statuses').querySelector('tbody');

function updateServiceMonitor() {
    fetch('/service-monitor/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Token': token,
        }
    })
    .then(res => res.json())
    .then(data => {
        // Expecting data to be a list (array) of objects
        if (Array.isArray(data)) {
            serviceStatuses.innerHTML = ''; // clear previous content
            data.forEach(service => {
                const row = document.createElement('tr');

                // create cells
                const nameCell = document.createElement('td');
                const statusCell = document.createElement('td');

                nameCell.textContent = service.service_name;
                statusCell.textContent = service.service_status?.Status || 'unknown';

                // color logic
                const state = service.service_status?.State;
                if (state === 'running') {
                    statusCell.style.color = 'green';
                } else if (state === 'stopped') {
                    statusCell.style.color = 'red';
                } else {
                    statusCell.style.color = 'black';
                }

                // assemble the row
                row.appendChild(nameCell);
                row.appendChild(statusCell);
                serviceStatuses.appendChild(row);
                });
        } else {
            serviceStatuses.textContent = 'Unexpected response format.';
        }
    })
    .catch(err => {
        console.error('error reading yapper status:', err);
        serviceStatuses.textContent = 'Error';
    });
}

// poll every second
setInterval(updateServiceMonitor, 5 * 60 * 1000);
updateServiceMonitor();